<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3 Sunburst with Vue (Dynamic Loading)</title>
    <!-- Vue 3 CDN (runtime + compiler) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- D3.js CDN -->
    <script src="https://unpkg.com/d3@7"></script>
    <style>
        /* Your original scoped styles, adapted */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #app {
            width: 95vw;
            height: 95vh;
            max-width: 1400px;
            max-height: 900px;
        }

        .sunburst-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            box-sizing: border-box;
            background-color: white;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 2em;
            font-weight: 300;
        }

        .header p {
            color: #7f8c8d;
            margin: 10px 0 0 0;
            font-size: 1em;
        }

        .breadcrumb {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #2c3e50;
            flex-shrink: 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .chart-container {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }

        .chart-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .chart-wrapper svg {
            max-width: 100%;
            max-height: 100%;
            width: 850px;
            height: auto;
        }

        .info-panel {
            width: 280px;
            flex-shrink: 0;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border-left: 4px solid #667eea;
            height: fit-content;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .info-panel h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.2em;
            word-break: break-word;
        }

        .info-item {
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #34495e;
            font-size: 0.9em;
        }

        .info-value {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 2px;
            word-break: break-word;
        }

        .status-active {
            color: #27ae60;
            font-weight: 600;
        }

        .status-completed {
            color: #3498db;
            font-weight: 600;
        }

        .status-ongoing {
            color: #f39c12;
            font-weight: 600;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            font-size: 1.2em;
            color: #666;
        }

        .error {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            font-size: 1.1em;
            color: #e74c3c;
            text-align: center;
            padding: 20px;
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .chart-container {
                flex-direction: column;
            }

            .info-panel {
                width: 100%;
                max-height: none;
            }

            .chart-wrapper {
                min-height: 500px;
            }
        }

        @media (max-width: 768px) {
            .sunburst-container {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .header p {
                font-size: 0.9em;
            }

            .chart-container {
                gap: 15px;
            }

            .info-panel {
                padding: 15px;
            }

            .chart-wrapper {
                min-height: 400px;
            }
        }

        @media (max-width: 480px) {
            .sunburst-container {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .breadcrumb {
                font-size: 0.8em;
                padding: 6px 12px;
            }

            .chart-wrapper {
                min-height: 350px;
            }

            .info-panel {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        const { createApp, ref, onMounted, nextTick, onBeforeUnmount } = Vue;
        
//#######################################################################################################################################   

        const zachmanData = {
  "name": "Personnel Security",
  "value": 100,
  "children": [
    {
      "name": "(Planners)",
      "value": 20,
      "children": [
        { "name": "What", "value": 5, "children": [{ "name": "critical assets – customer data, financial information, intellectual property." }] },
        { "name": "How", "value": 5, "children": [{ "name": "Personnel Security Policy (screening, onboarding, exit process)." }] },
        { "name": "Where", "value": 5, "children": [{ "name": "Identify where the data resides – HQ, branches, or cloud systems." }] },
        { "name": "Who", "value": 5, "children": [{ "name": "Assigns responsibility → CISO, HR Head. They are accountable." }] },
        { "name": "When", "value": 5, "children": [{ "name": "Defines timelines – annual audits, background verification every 3 years." }] },
        { "name": "Why", "value": 5, "children": [{ "name": "Motivation is compliance and trust (NIST, ISO, GDPR)." }] }
      ]
    },
    {
      "name": "(Owners)",
      "value": 20,
      "children": [
        { "name": "What", "value": 5, "children": [{ "name": "Employee HR records, access lists." }] },
        { "name": "How", "value": 5, "children": [{ "name": "Hiring process, background verification." }] },
        { "name": "Where", "value": 5, "children": [{ "name": "Offices, data centers where staff will work." }] },
        { "name": "Who", "value": 5, "children": [{ "name": "HR Managers, Department Heads." }] },
        { "name": "When", "value": 5, "children": [{ "name": "Pre-employment, periodic re-checks." }] },
        { "name": "Why", "value": 5, "children": [{ "name": "Reduce insider threat, maintain workforce integrity." }] }
      ]
    },
    {
      "name": " (Designers)",
      "value": 20,
      "children": [
        { "name": "What", "value": 5, "children": [{ "name": "Identity database, access token system." }] },
        { "name": "How", "value": 5, "children": [{ "name": "Designing role-based access (RBAC)." }] },
        { "name": "Where", "value": 5, "children": [{ "name": "Authentication servers, Active Directory." }] },
        { "name": "Who", "value": 5, "children": [{ "name": "Assign access based on roles – admin, developer, HR." }] },
        { "name": "When", "value": 5, "children": [{ "name": "During onboarding, transfers, or exit." }] },
        { "name": "Why", "value": 5, "children": [{ "name": "Principle of Least Privilege (only needed access)." }] }
      ]
    },
    {
      "name": "(Builders)",
      "value": 20,
      "children": [
        { "name": "What", "value": 5, "children": [{ "name": "ID cards, laptops, MFA devices." }] },
        { "name": "How", "value": 5, "children": [{ "name": "Configure MFA, VPN, DLP." }] },
        { "name": "Where", "value": 5, "children": [{ "name": "Endpoints, servers, cloud platforms." }] },
        { "name": "Who", "value": 5, "children": [{ "name": "System admins, IT security staff." }] },
        { "name": "When", "value": 5, "children": [{ "name": "Daily monitoring, weekly checks." }] },
        { "name": "Why", "value": 5, "children": [{ "name": "To ensure smooth, secure operation." }] }
      ]
    },
    {
      "name": "(Implementers)",
      "value": 20,
      "children": [
        { "name": "What", "value": 5, "children": [{ "name": "User accounts, credentials." }] },
        { "name": "How", "value": 5, "children": [{ "name": "Disable accounts immediately when employee exits." }] },
        { "name": "Where", "value": 5, "children": [{ "name": "Local office systems, HR portal." }] },
        { "name": "Who", "value": 5, "children": [{ "name": "IT helpdesk, support engineers." }] },
        { "name": "When", "value": 5, "children": [{ "name": "Immediately at resignation or transfer." }] },
        { "name": "Why", "value": 5, "children": [{ "name": "Prevent data leakage or misuse." }] }
      ]
    },
    {
      "name": "(Users)",
      "value": 20,
      "children": [
        { "name": "What", "value": 5, "children": [{ "name": "Personal user accounts, email IDs." }] },
        { "name": "How", "value": 5, "children": [{ "name": "Follow company security policies." }] },
        { "name": "Where", "value": 5, "children": [{ "name": "Workstations, BYOD (Bring Your Own Device)." }] },
        { "name": "Who", "value": 5, "children": [{ "name": "Employees, contractors." }] },
        { "name": "When", "value": 5, "children": [{ "name": "Daily job execution." }] },
        { "name": "Why", "value": 5, "children": [{ "name": "Responsibility, trust, and compliance." }] }
      ]
    }
  ]
};


//#######################################################################################################################################   
     
        const dataMap = {
            '1': zachmanData,
            'default': zachmanData
        };

//#######################################################################################################################################   
        const SunburstChart = {
            template: `
                <div class="sunburst-container">
                 

                    <div v-if="loading" class="loading">
                        Loading {{ viewType || 'default' }} data...
                    </div>

                    <div v-else-if="error" class="error">
                        <div>
                            <div>{{ error }}</div>
                            <div style="margin-top: 10px; font-size: 0.9em;">
                                Loading default data instead...
                            </div>
                        </div>
                    </div>

                    <div v-else>
                        <div class="breadcrumb" v-if="breadcrumb.length > 0">
                            Path: {{ breadcrumb.join(' → ') }}
                        </div>

                        <div class="chart-container">
                            <div class="chart-wrapper">
                                <svg ref="sunburstSvg"></svg>
                            </div>

                            <div class="info-panel">
                                <h3>{{ selectedNode ? selectedNode.data.name : 'Organization Overview' }}</h3>

                                <div v-if="selectedNode && selectedNode.data.status">
                                    <div class="info-item">
                                        <div class="info-label">Status</div>
                                        <div class="info-value" :class="getStatusClass(selectedNode.data.status)">
                                            {{ selectedNode.data.status }}
                                        </div>
                                    </div>
                                </div>

                                <div v-if="selectedNode && selectedNode.data.type">
                                    <div class="info-item">
                                        <div class="info-label">Type</div>
                                        <div class="info-value">{{ selectedNode.data.type }}</div>
                                    </div>
                                </div>

                                <div v-if="selectedNode && selectedNode.data.role">
                                    <div class="info-item">
                                        <div class="info-label">Role</div>
                                        <div class="info-value">{{ selectedNode.data.role }}</div>
                                    </div>
                                </div>

                                <div v-if="selectedNode && selectedNode.data.contact">
                                    <div class="info-item">
                                        <div class="info-label">Contact</div>
                                        <div class="info-value">{{ selectedNode.data.contact }}</div>
                                    </div>
                                </div>

                                <div v-if="selectedNode && selectedNode.data.frequency">
                                    <div class="info-item">
                                        <div class="info-label">Frequency</div>
                                        <div class="info-value">{{ selectedNode.data.frequency }}</div>
                                    </div>
                                </div>

                                <div v-if="selectedNode && selectedNode.data.value">
                                    <div class="info-item">
                                        <div class="info-label">Value</div>
                                        <div class="info-value">{{ formatNumber(selectedNode.data.value) }}</div>
                                    </div>
                                </div>

                                <div v-if="!selectedNode || (!selectedNode.data.status && !selectedNode.data.type && !selectedNode.data.role && !selectedNode.data.contact && !selectedNode.data.frequency)">
                                    <div class="info-item">
                                        <div class="info-label">Data Source</div>
                                        <div class="info-value">{{ dataSource }}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">View Type</div>
                                        <div class="info-value">{{ viewType || 'Default' }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            setup() {
                // Reactive data
                const sunburstSvg = ref(null);
                const selectedNode = ref(null);
                const breadcrumb = ref([]);
                const chartData = ref(null);
                const loading = ref(true);
                const error = ref(null);
                const viewType = ref('');
                const chartTitle = ref('Dynamic Sunburst Chart');
                const dataSource = ref('');

                // Refs for center text elements
                const centerName = ref(null);
                const centerSub = ref(null);

                // Get URL parameters
                const getUrlParameter = (name) => {
                    const urlParams = new URLSearchParams(window.location.search);
                    return urlParams.get(name);
                };

                // Load data based on view parameter
                const loadData = () => {
                    const view = getUrlParameter('v');
                    viewType.value = view;
                    
                    // Get data from embedded variables
                    let selectedData;
                    if (view && dataMap[view]) {
                        selectedData = dataMap[view];
                        dataSource.value = `Embedded (${view})`;
                    } else {
                        // Fallback to default if view parameter is not found
                        selectedData = zachmanData;
                        dataSource.value = 'Embedded (default)';
                        if (view) {
                            error.value = `View "${view}" not found. Available views: ${Object.keys(dataMap).filter(k => k !== 'default').join(', ')}`;
                            // Clear error after showing default data
                            setTimeout(() => {
                                error.value = null;
                            }, 3000);
                        }
                    }
                    
                    chartData.value = selectedData;
                    chartTitle.value = selectedData.name || `${view ? view.charAt(0).toUpperCase() + view.slice(1) : 'Default'} Framework`;
                    loading.value = false;
                };

                // Methods
                const getStatusClass = (status) => {
                    if (status === 'Active') return 'status-active';
                    if (status === 'Completed') return 'status-completed';
                    if (status === 'Ongoing') return 'status-ongoing';
                    return '';
                };

                const formatNumber = (value) => {
                    return d3.format(",d")(value);
                };

                const updateBreadcrumb = (d) => {
                    const newBreadcrumb = [];
                    let current = d;
                    while (current.parent) {
                        newBreadcrumb.unshift(current.data.name);
                        current = current.parent;
                    }
                    newBreadcrumb.unshift(chartData.value?.name || 'Root');
                    breadcrumb.value = newBreadcrumb;
                };

                const arcVisible = (d) => {
                    return d.y1 <= 3 && d.y0 >= 1 && d.x1 > d.x0;
                };

                const labelVisible = (d) => {
                    return d.y1 <= 3 && d.y0 >= 1 && (d.y1 - d.y0) * (d.x1 - d.x0) > 0.03;
                };

                const labelTransform = (d, radius) => {
                    const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
                    const y = (d.y0 + d.y1) / 2 * radius;
                    return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
                };

                const getContainerDimensions = () => {
                    const container = sunburstSvg.value?.parentElement;
                    if (!container) return { width: 800, height: 600 };

                    const rect = container.getBoundingClientRect();
                    const effectiveWidth = rect.width - 40;
                    const effectiveHeight = rect.height - 40;

                    const minSize = Math.min(effectiveWidth, effectiveHeight);
                    return {
                        width: Math.max(minSize, 400),
                        height: Math.max(minSize, 400)
                    };
                };

                const createSunburst = () => {
                    if (!chartData.value || !sunburstSvg.value) return;

                    const dimensions = getContainerDimensions();
                    const size = Math.min(dimensions.width, dimensions.height);
                    const radius = size / 6;

                    d3.select(sunburstSvg.value).selectAll("*").remove();

                    const color = d3.scaleOrdinal(d3.quantize(d3.interpolateRainbow, chartData.value.children.length + 1));

                    const hierarchy = d3.hierarchy(chartData.value)
                        .sum(d => d.value || 1)
                        .sort((a, b) => b.value - a.value);

                    const root = d3.partition()
                        .size([2 * Math.PI, hierarchy.height + 1])
                        (hierarchy);

                    root.each(d => d.current = d);

                    const arc = d3.arc()
                        .startAngle(d => d.x0)
                        .endAngle(d => d.x1)
                        .padAngle(d => Math.min((d.x1 - d.x0) / 2, 0.005))
                        .padRadius(radius * 1.5)
                        .innerRadius(d => d.y0 * radius)
                        .outerRadius(d => Math.max(d.y0 * radius, d.y1 * radius - 1));

                    const svg = d3.select(sunburstSvg.value)
                        .attr("width", "100%")
                        .attr("height", "100%")
                        .attr("viewBox", [-size / 2, -size / 2, size, size])
                        .style("font", `${Math.max(10, size / 60)}px sans-serif`);

                    const clicked = (event, p) => {
                        selectedNode.value = p;
                        updateBreadcrumb(p);

                        parentCircle.datum(p.parent || root);

                        root.each(d => d.target = {
                            x0: Math.max(0, Math.min(1, (d.x0 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
                            x1: Math.max(0, Math.min(1, (d.x1 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
                            y0: Math.max(0, d.y0 - p.depth),
                            y1: Math.max(0, d.y1 - p.depth)
                        });

                        const t = svg.transition().duration(event.altKey ? 7500 : 750);

                        path.transition(t)
                            .tween("data", d => {
                                const i = d3.interpolate(d.current, d.target);
                                return t => d.current = i(t);
                            })
                            .filter(function(d) {
                                return +this.getAttribute("fill-opacity") || arcVisible(d.target);
                            })
                            .attr("fill-opacity", d => arcVisible(d.target) ? (d.children ? 0.6 : 0.4) : 0)
                            .attr("pointer-events", d => arcVisible(d.target) ? "auto" : "none")
                            .attrTween("d", d => () => arc(d.current));

                        label.filter(function(d) {
                            return +this.getAttribute("fill-opacity") || labelVisible(d.target);
                        }).transition(t)
                            .attr("fill-opacity", d => +labelVisible(d.target))
                            .attrTween("transform", d => () => labelTransform(d.current, radius));

                        if (centerName.value && centerSub.value) {
                            centerName.value.text(p.data.name);
                            centerSub.value.text(p.parent ? p.parent.data.name : "Overview");
                        }
                    };

                    const path = svg.append("g")
                        .selectAll("path")
                        .data(root.descendants().slice(1))
                        .join("path")
                            .attr("fill", d => { while (d.depth > 1) d = d.parent; return color(d.data.name); })
                            .attr("fill-opacity", d => arcVisible(d.current) ? (d.children ? 0.6 : 0.4) : 0)
                            .attr("pointer-events", d => arcVisible(d.current) ? "auto" : "none")
                            .attr("d", d => arc(d.current))
                            .style("cursor", "pointer")
                            .on("click", clicked)
                            .on("mouseover", function(event, d) {
                                d3.select(this).style("opacity", 0.8);
                            })
                            .on("mouseout", function(event, d) {
                                d3.select(this).style("opacity", 1);
                            });

                    path.append("title")
                        .text(d => `${d.ancestors().map(d => d.data.name).reverse().join("/")}\n${formatNumber(d.value)}`);

                    const label = svg.append("g")
                        .attr("pointer-events", "none")
                        .attr("text-anchor", "middle")
                        .style("user-select", "none")
                        .selectAll("text")
                        .data(root.descendants().slice(1))
                        .join("text")
                            .attr("dy", "0.35em")
                            .attr("fill-opacity", d => +labelVisible(d.current))
                            .attr("transform", d => labelTransform(d.current, radius))
                            .text(d => d.data.name)
                            .style("font-size", `${Math.max(8, size / 80)}px`)
                            .style("font-weight", "600")
                            .style("fill", "#2c3e50");

                    const parentCircle = svg.append("circle")
                        .datum(root)
                        .attr("r", radius)
                        .attr("fill", "none")
                        .attr("pointer-events", "all")
                        .style("cursor", "pointer")
                        .on("click", clicked);

                    centerName.value = svg.append("text")
                        .attr("text-anchor", "middle")
                        .attr("dy", "-0.5em")
                        .style("font-size", `${Math.max(16, size / 30)}px`)
                        .style("font-weight", "600")
                        .style("fill", "#2c3e50")
                        .style("pointer-events", "none")
                        .text(root.data.name);

                    centerSub.value = svg.append("text")
                        .attr("text-anchor", "middle")
                        .attr("dy", "1em")
                        .style("font-size", `${Math.max(12, size / 40)}px`)
                        .style("fill", "#7f8c8d")
                        .style("pointer-events", "none")
                        .text("Overview");

                    selectedNode.value = root;
                    updateBreadcrumb(root);
                };

                // Watch for data changes
                const watchData = () => {
                    if (chartData.value && !loading.value && !error.value) {
                        nextTick(() => {
                            createSunburst();
                        });
                    }
                };

                // Resize handler
                const handleResize = () => {
                    if (chartData.value && !loading.value && !error.value) {
                        createSunburst();
                    }
                };

                // Lifecycle hooks
                onMounted(async () => {
                    loadData();
                    window.addEventListener('resize', handleResize);
                });

                onBeforeUnmount(() => {
                    window.removeEventListener('resize', handleResize);
                });

                // Watch chartData for changes
                Vue.watch(() => chartData.value, watchData, { immediate: true });

                return {
                    sunburstSvg,
                    selectedNode,
                    breadcrumb,
                    loading,
                    error,
                    viewType,
                    chartTitle,
                    dataSource,
                    getStatusClass,
                    formatNumber,
                };
            }
        };

        createApp(SunburstChart).mount('#app');
    </script>
</body>
</html>